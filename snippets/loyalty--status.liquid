{% comment %}
NOTE: There is no swell_vip_mate customer tag defined as of this moment. All customers are automatically opt-in based on checking a newly created account in Shopify admin -> Yotpo admin
{% endcomment %}
{% assign account_loyalty_level_tag = 'swell_vip_mate' %}
{% assign secret_level_tag = 'swell_vip_' | append: settings.last_level_name | downcase %}

{% assign account_total_spend = 0 %}

{% for order in customer.orders %}
  {% if order.financial_status == 'paid' or order.financial_status == 'partially_refunded' %}
    {% assign account_total_spend = account_total_spend | plus: order.total_price | minus: order.total_refunded_amount %}
  {% endif %}
{% endfor %}

{% for tag in customer.tags %}
  {% if tag contains 'swell_vip_' %}
    {% assign account_loyalty_level_tag = tag %}
  {% endif %}
{% endfor %}

{% assign loyalty_levels = settings.loyalty_levels | newline_to_br | split: "<br />" %}

{% assign look_for_level = account_loyalty_level_tag | remove_first: 'swell_vip_' | prepend: '|' | append: '|' %}
{% assign compare_settings_loyalty_levels = settings.loyalty_levels | downcase %}

{%- if compare_settings_loyalty_levels contains look_for_level -%}

  <section class="AccountLoyalty_Section">
    <div class="AccountTimeline_Column"></div>
    <div class="AccountClassification_Column">

      {% assign current_level_index = blank %}
      {% assign next_level_index = blank %}
      {% assign next_level_cost_remaining = blank %}
      {% assign display_next_level_cost_remaining = blank %}
      
      {% for loyalty_level in loyalty_levels  %}
      
        {% assign should_render = false %}
      
        {% assign next_level_tag = blank %}

        {% assign last_index = forloop.length %}

        {% assign loyalty_level_details = loyalty_level | split: '|' %}
        {% assign level = loyalty_level_details[0] %}
        {% assign level_name = loyalty_level_details[1] %}
        {% assign level_requirement = loyalty_level_details[2] %}
        {% assign level_requirement_cost = loyalty_level_details[3] %}
        {% assign level_color = loyalty_level_details[4] %}

        {% assign current_level_tag = 'swell_vip_' | append: level_name | downcase %}

        {% if current_level_tag ==  account_loyalty_level_tag %}
          {% assign current_level_index = forloop.index %}
        {% endif %}

        {% if current_level_index < last_index %}
          {% assign next_level_index = current_level_index | plus: 1 %}
          {% assign next_level_cost_remaining = level_requirement_cost | times: 100 | minus: account_total_spend %}
          {% assign display_next_level_cost_remaining = next_level_cost_remaining | money_without_currency | replace: ',', '' %}
        {% endif %}
        
        {% if account_loyalty_level_tag != secret_level_tag and forloop.last == false %}
          {% assign should_render = true %}
        {% elsif account_loyalty_level_tag == secret_level_tag and forloop.last == false %}
          {% assign should_render = true %}
        {% elsif account_loyalty_level_tag == secret_level_tag and forloop.last == true %}
          {% assign should_render = true %}
        {% endif %}

        {% if should_render == true %}
          <div class="AccountClassification">
            <div class="MarkerContainer">
              
              {% if current_level_tag ==  account_loyalty_level_tag %}
                <div class="AccountStatus_CurrentMarker">
                  {% comment %}<img src="{{ 'loyalty-account-icon-location.svg' | asset_url }}" alt="Tier marker" />{% endcomment %}
                  <svg width="27" height="35" viewBox="0 0 27 35" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M1.21957 8.34917C1.91969 6.60534 2.97721 5.02744 4.32405 3.71705C6.76542 1.50544 9.95108 0.295957 13.2451 0.330047C19.7191 0.330047 26.2691 4.95905 26.2751 13.842C26.2751 21.22 14.3021 33.453 13.7751 33.979C13.7165 34.0519 13.6419 34.1102 13.557 34.1494C13.4722 34.1886 13.3795 34.2076 13.2861 34.205C13.1876 34.2043 13.0903 34.184 12.9998 34.1452C12.9093 34.1064 12.8274 34.0499 12.7591 33.979C12.2281 33.453 0.259054 21.107 0.259054 13.842C0.192263 11.9641 0.519457 10.093 1.21957 8.34917ZM7.82505 12.6C7.82611 14.0473 8.40149 15.4349 9.42484 16.4583C10.4482 17.4816 11.8358 18.057 13.2831 18.058C13.9977 18.0619 14.706 17.9246 15.3675 17.654C16.0289 17.3834 16.6304 16.9849 17.1375 16.4814C17.6446 15.9778 18.0473 15.3791 18.3225 14.7196C18.5976 14.0601 18.7399 13.3527 18.7411 12.638C18.7403 11.1907 18.165 9.80294 17.1416 8.77954C16.1182 7.75613 14.7304 7.18084 13.2831 7.18005C12.5685 7.17636 11.8602 7.31376 11.1988 7.58437C10.5374 7.85497 9.93595 8.25347 9.42889 8.757C8.92183 9.26053 8.51915 9.85919 8.24393 10.5187C7.96871 11.1781 7.82636 11.8855 7.82505 12.6Z" fill="{{ level_color }}"/>
                  </svg>

                  <span class="label">{{ 'customer.account.rewards_loyalty.current_loyalty_level' | t }}</span>
                </div>
                <span class="DotMarker__Active" style="background-color: {{ level_color }};"></span>
              {% endif %}
              
              {% if next_level_index == forloop.index %}

                <div class="AccountStatus_Marker">
                  {% comment %}<img src="{{ 'loyalty-account-icon-location-black.svg' | asset_url }}" alt="SVG"/>{% endcomment %}
                  <svg width="27" height="35" viewBox="0 0 27 35" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M1.21957 8.34917C1.91969 6.60534 2.97721 5.02744 4.32405 3.71705C6.76542 1.50544 9.95108 0.295957 13.2451 0.330047C19.7191 0.330047 26.2691 4.95905 26.2751 13.842C26.2751 21.22 14.3021 33.453 13.7751 33.979C13.7165 34.0519 13.6419 34.1102 13.557 34.1494C13.4722 34.1886 13.3795 34.2076 13.2861 34.205C13.1876 34.2043 13.0903 34.184 12.9998 34.1452C12.9093 34.1064 12.8274 34.0499 12.7591 33.979C12.2281 33.453 0.259054 21.107 0.259054 13.842C0.192263 11.9641 0.519457 10.093 1.21957 8.34917ZM7.82505 12.6C7.82611 14.0473 8.40149 15.4349 9.42484 16.4583C10.4482 17.4816 11.8358 18.057 13.2831 18.058C13.9977 18.0619 14.706 17.9246 15.3675 17.654C16.0289 17.3834 16.6304 16.9849 17.1375 16.4814C17.6446 15.9778 18.0473 15.3791 18.3225 14.7196C18.5976 14.0601 18.7399 13.3527 18.7411 12.638C18.7403 11.1907 18.165 9.80294 17.1416 8.77954C16.1182 7.75613 14.7304 7.18084 13.2831 7.18005C12.5685 7.17636 11.8602 7.31376 11.1988 7.58437C10.5374 7.85497 9.93595 8.25347 9.42889 8.757C8.92183 9.26053 8.51915 9.85919 8.24393 10.5187C7.96871 11.1781 7.82636 11.8855 7.82505 12.6Z" fill="#f9c6b9"/>
                  </svg>

                  {% comment %}
                  If next level cost remaining is negative. It means that Yotpo hasn't updated the customer tags yet. We're showing a fallback message just in case of delays.
                  {% endcomment %}
                  {% if next_level_cost_remaining < 0  %}
                    <span class="label">{{ 'customer.account.rewards_loyalty.almost_indicator' | t }}</span>
                  {% else %}
                    <span class="label">${{ 'customer.account.rewards_loyalty.level_cost_remaining' | t: cost: display_next_level_cost_remaining }}</span>
                  {% endif %}
                </div>

                <span class="DotMarker__Next"></span>
              {% endif %}

            </div>

            <div class="LoyaltyClassificationData">
              <span class="Level" style="color: {{ level_color }}">{{ 'customer.account.rewards_loyalty.level' | t: level: level }}</span>
              <span class="Name">{{ level_name }}</span>
              <span class="RequirementStatement">{{ level_requirement }}</span>
            </div>
          </div>
        {% endif %}

      {% endfor %}
      
    </div>
  </section>

{%- endif -%}